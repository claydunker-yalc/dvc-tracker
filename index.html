<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DVC Master Tracker</title>
    <style>
        @font-face { font-family: 'DisneyMagic'; src: url('waltograph42.ttf'); }
        @font-face { font-family: 'UniversBold'; src: url('SNBold.ttf'); }
        @font-face { font-family: 'UniversRegular'; src: url('SNRegular.ttf'); }

        :root {
            --sign-purple: #3b1660; --sign-red: #d31130; --sign-yellow: #fff200; 
            --sign-blue: #0072bc; --sign-white: #ffffff;
        }

        body {
            background: url('background.png') no-repeat center bottom fixed;
            background-size: cover; font-family: 'UniversRegular', sans-serif;
            display: flex; flex-direction: column; align-items: center; padding-bottom: 80px; margin: 0;
        }

        .spacer-top { height: 12vh; width: 100%; flex-shrink: 0; }

        .sign-container {
            max-width: 650px; width: 95%; background-color: var(--sign-purple); color: var(--sign-white);
            border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.8); border: 6px solid #333;
            display: flex; flex-direction: column; overflow: hidden;
        }

        header { padding: 20px; text-align: center; }
        h1 { font-family: 'DisneyMagic', cursive; margin: 0; font-size: 3rem; color: var(--sign-white); text-shadow: 3px 3px 0px var(--sign-blue); }
        .welcome-msg { font-family: 'UniversBold'; color: var(--sign-yellow); letter-spacing: 3px; font-size: 1.1rem; text-transform: uppercase; margin-top: 5px; }

        .tabs { display: flex; background: rgba(0,0,0,0.4); border-top: 4px solid var(--sign-red); border-bottom: 4px solid var(--sign-red); overflow-x: auto; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; color: white; font-family: 'UniversBold'; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; min-width: 90px; }
        .tab-btn.active { background: var(--sign-red); color: var(--sign-yellow); }

        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }

        /* General Cards */
        .dashboard-contract-card { background: white; color: #333; border-radius: 8px; margin-bottom: 15px; border-left: 12px solid var(--sign-blue); box-shadow: 0 4px 10px rgba(0,0,0,0.3); overflow: hidden; }
        .card-header { padding: 10px 15px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-weight: bold; }
        .point-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; text-align: center; padding: 12px 5px; }
        .point-val { font-family: 'UniversBold'; font-size: 1.3rem; color: var(--sign-purple); display: block; }
        .point-label { font-size: 0.6rem; color: #666; text-transform: uppercase; }

        /* Date Nav */
        .date-nav-bar { display: flex; align-items: center; justify-content: space-between; background: var(--sign-white); color: var(--sign-purple); border-radius: 8px; margin-bottom: 15px; padding: 8px; }
        .nav-arrow { background: var(--sign-blue); color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer; font-family: 'UniversBold'; font-size: 1.2rem; }
        .nav-arrow:disabled { background: #ccc; cursor: not-allowed; }
        .current-date-display { flex-grow: 1; text-align: center; font-family: 'UniversBold'; font-size: 1.1rem; cursor: pointer; }

        /* Creation UI */
        .creation-card { background: white; color: #333; border-radius: 8px; padding: 15px; border-left: 10px solid var(--sign-blue); box-shadow: 0 4px 10px rgba(0,0,0,0.2); margin-bottom: 15px; }
        .theme-section { background: #f0f4f8; padding: 12px; border-radius: 6px; border: 1px solid #d1d9e6; margin-bottom: 15px; }
        .theme-header { font-family: 'UniversBold'; color: var(--sign-blue); margin-bottom: 8px; font-size: 0.8rem; text-transform: uppercase; }

        /* Itinerary UI */
        .plan-day-card { background: white; color: #333; border-radius: 8px; padding: 15px; border-left: 10px solid var(--sign-red); box-shadow: 0 4px 10px rgba(0,0,0,0.2); margin-bottom: 15px; }
        .plan-day-card h4 { margin: 0 0 5px 0; color: var(--sign-purple); font-family: 'UniversBold'; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .view-theme-label { font-family: 'UniversBold'; color: var(--sign-blue); font-size: 1rem; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px dashed #eee; }
        .auto-tag { font-family: 'UniversBold'; font-size: 0.75rem; color: var(--sign-red); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }

        .view-item { padding: 10px; border-bottom: 1px dashed #ccc; display: flex; align-items: baseline; position: relative; }
        .view-time { color: var(--sign-blue); font-family: 'UniversBold'; min-width: 100px; font-size: 0.85rem; }
        .view-desc { font-size: 0.95rem; flex-grow: 1; padding-right: 30px; }
        .trash-btn { position: absolute; right: 5px; top: 10px; color: var(--sign-red); cursor: pointer; font-size: 1.1rem; }

        input, select { padding: 10px; border-radius: 4px; border: 1px solid #ccc; width: 100%; font-family: 'UniversRegular'; box-sizing: border-box; }
        label { font-size: 0.65rem; font-family: 'UniversBold'; color: var(--sign-purple); text-transform: uppercase; display: block; margin-top: 5px; margin-bottom: 2px; }

        .disney-button { background: var(--sign-yellow); color: #333; border: none; padding: 15px; font-family: 'UniversBold'; cursor: pointer; text-transform: uppercase; width: 100%; border-radius: 4px; margin-bottom: 10px; }
        .sync-btn { background: var(--sign-red); color: white; border: 3px solid var(--sign-yellow); margin-top: 10px; }
        .footer-red { background-color: var(--sign-red); padding: 18px 10px; text-align: center; font-family: 'UniversBold'; color: var(--sign-yellow); text-transform: uppercase; border-top: 4px solid var(--sign-yellow); letter-spacing: 2px; }
        .sync-stamp { display: block; font-size: 0.65rem; margin-top: 6px; color: var(--sign-white); text-transform: none; letter-spacing: normal; opacity: 0.9; }
    </style>
</head>
<body>

<div class="spacer-top"></div>

<div class="sign-container">
    <header>
        <h1>Dvc Point Tracker</h1>
        <div class="welcome-msg">WELCOME HOME DUNKER FAMILY!</div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('home', this)">Dashboard</button>
        <button class="tab-btn" onclick="showTab('plans', this)">Plans</button>
        <button class="tab-btn" onclick="showTab('trips', this)">Trips</button>
        <button class="tab-btn" onclick="showTab('settings', this)">Contracts</button>
    </div>

    <div id="home" class="tab-content active">
        <div id="grandTotal" style="font-size: 2.5rem; color: var(--sign-yellow); text-align: center; margin-bottom: 20px; font-family: 'UniversBold';">TOTAL: 0 PTS</div>
        <div id="nextTripDisplay"></div>
        <h3 style="border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 8px;">REMAINING BY CYCLE</h3>
        <div id="contractSummary"></div>
    </div>

    <div id="plans" class="tab-content">
        <select id="planTripSelect" onchange="initPlanView()" style="margin-bottom:15px;"></select>
        
        <div id="planArea" style="display:none;">
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <button id="viewBtn" class="tab-btn active" style="font-size:0.7rem; min-width:unset; background:rgba(0,0,0,0.3)" onclick="setPlanMode('view')">View Itinerary</button>
                <button id="editBtn" class="tab-btn" style="font-size:0.7rem; min-width:unset; background:rgba(0,0,0,0.3)" onclick="setPlanMode('edit')">Add New Plan</button>
            </div>

            <div id="creationStation" style="display:none;">
                <div class="date-nav-bar">
                    <button id="prevDate" class="nav-arrow" onclick="changeDate(-1)">‚ùÆ</button>
                    <div class="current-date-display" id="displayDateText">Date</div>
                    <button id="nextDate" class="nav-arrow" onclick="changeDate(1)">‚ùØ</button>
                </div>

                <div class="theme-section">
                    <div class="theme-header">Day Theme / Destination</div>
                    <select id="dayTypeSelect" onchange="updateDayTheme('type', this.value)" style="margin-bottom:10px;">
                        <option value="">-- No Theme Set --</option>
                        <option value="Park Day">Park Day</option>
                        <option value="Resort Day">Resort Day</option>
                    </select>
                    <div id="dayLocWrapper"></div>
                </div>

                <div class="creation-card">
                    <div class="theme-header" style="color:var(--sign-purple)">Add Activity</div>
                    <div class="form-section" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div><label>Start Time</label><input type="time" id="newStartTime"></div>
                        <div><label>End Time (Opt)</label><input type="time" id="newEndTime"></div>
                    </div>
                    
                    <div class="form-section">
                        <label>Event Type</label>
                        <select id="newType" onchange="toggleFormMenus()">
                            <option value="Other">Other / Memo</option>
                            <option value="Dining">Dining</option>
                            <option value="Lightning Lane">Lightning Lane</option>
                            <option value="Show">Show / Event</option>
                        </select>
                    </div>

                    <div id="diningLogic" style="display:none;">
                        <label>Dining Type</label>
                        <select id="newDiningSrv" onchange="updateDiningCategory()"></select>
                        <div id="catWrapper"></div>
                        <div id="locWrapper"></div>
                        <div id="venueWrapper"></div>
                    </div>

                    <div id="otherDetails">
                        <label>Details</label>
                        <input type="text" id="newDesc" placeholder="e.g. Flight to Orlando">
                    </div>

                    <button class="disney-button" style="margin-top:20px; background:var(--sign-blue); color:white;" onclick="addPlanFromForm()">Add to Itinerary</button>
                </div>
            </div>

            <div id="itineraryDisplay"></div>
            <button class="disney-button sync-btn" onclick="saveToCloud()">Push to Cloud</button>
        </div>
    </div>

    <div id="trips" class="tab-content">
        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px;">
            <input type="text" id="tripName" placeholder="Trip Name">
            <select id="tripResort" style="margin: 10px 0;">
                <option value="" disabled selected>Select Resort</option>
                <option value="Animal Kingdom Lodge">Animal Kingdom Lodge</option>
                <option value="Aulani">Aulani</option>
                <option value="Bay Lake Tower">Bay Lake Tower</option>
                <option value="Beach Club">Beach Club</option>
                <option value="BoardWalk">BoardWalk</option>
                <option value="Boulder Ridge">Boulder Ridge</option>
                <option value="Copper Creek">Copper Creek</option>
                <option value="Fort Wilderness Cabins">Fort Wilderness Cabins</option>
                <option value="Grand Californian">Grand Californian</option>
                <option value="Grand Floridian">Grand Floridian</option>
                <option value="Hilton Head Island">Hilton Head Island</option>
                <option value="Old Key West">Old Key West</option>
                <option value="Polynesian">Polynesian</option>
                <option value="Riviera">Riviera</option>
                <option value="Saratoga Springs">Saratoga Springs</option>
                <option value="Vero Beach">Vero Beach</option>
                <option value="Villas at Disneyland Hotel">Villas at Disneyland Hotel</option>
            </select>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                <input type="date" id="checkIn">
                <input type="date" id="checkOut">
            </div>
            <button class="disney-button" onclick="addTrip()">Add Trip</button>
        </div>
        <div id="tripManager" style="margin-top:20px;"></div>
    </div>

    <div id="settings" class="tab-content">
        <div id="contractEditor"></div>
        <button class="disney-button sync-btn" onclick="saveToCloud()">Push to Cloud</button>
    </div>

    <div class="footer-red">
        THE MOST MAGICAL PLACE ON EARTH
        <div id="lastSync" class="sync-stamp">Initializing Cloud...</div>
    </div>
</div>

<script>
    const BIN_ID = '6954b02eae596e708fbb8118';
    const API_KEY = '$2a$10$B2lcgtW9TRoKhvXKDEHxWenp5jGdJL.a2op6oWw8yoVf5Pocmtu3.'; 
    const URL = 'https://api.jsonbin.io/v3/b/' + BIN_ID;

    const diningDatabase = {"Quick Service": {"Park": {"Magic Kingdom": ["Casey\u2019s Corner", "Columbia Harbour House", "Cosmic Ray\u2019s Starlight Caf\u00e9", "Friar\u2019s Nook", "Gaston\u2019s Tavern", "Golden Oak Outpost", "Main Street Bakery (Starbucks)", "Pecos Bill Tall Tale Inn and Cafe", "Pinocchio Village Haus", "Sleepy Hollow", "The Lunching Pad", "Tomorrowland Terrace (when operating)"], "EPCOT": ["Connections Caf\u00e9 (Starbucks)", "Connections Eatery", "Cr\u00eapes \u00c0 Emporter", "Katsura Grill", "Kringla Bakeri Og Kafe", "La Cantina de San Angel", "Les Halles Boulangerie\u2011Patisserie", "Regal Eagle Smokehouse", "Sommerfest", "Sunshine Seasons", "Yorkshire County Fish Shop"], "Hollywood Studios": ["ABC Commissary", "Backlot Express", "Catalina Eddie\u2019s", "Docking Bay 7 Food and Cargo", "Fairfax Fare", "PizzeRizzo", "Ronto Roasters", "Rosie\u2019s All\u2011American Caf\u00e9", "Woody\u2019s Lunch Box"], "Animal Kingdom": ["Flame Tree Barbecue", "Harambe Market", "Pizzafari", "Restaurantosaurus", "Satu\u2019li Canteen", "Yak & Yeti Local Food Cafes"]}, "Resort": {"Riviera": ["Bar Riva", "Le Petit Caf\u00e9", "Primo Piatto"], "Beach Club": ["Beach Club Marketplace", "Hurricane Hanna\u2019s Waterside Bar & Grill"], "Grand Floridian": ["Beaches Pool Bar & Grill", "Gasparilla Island Grill"], "BoardWalk": ["BoardWalk Deli"], "Coronado Springs": ["Caf\u00e9 Rix", "El Mercado de Coronado"], "Polynesian": ["Capt. Cook\u2019s", "Oasis Bar & Grill"], "Caribbean Beach": ["Centertown Market", "Spyglass Grill"], "Contemporary": ["Contempo Caf\u00e9", "Sand Bar"], "All\u2011Star Sports": ["End Zone Food Court"], "Pop Century": ["Everything POP Dining"], "Wilderness Lodge": ["Geyser Point Bar & Grill", "Roaring Fork"], "Old Key West": ["Good\u2019s Food to Go"], "All\u2011Star Music": ["Intermission Food Court"], "Art of Animation": ["Landscape of Flavors"], "Fort Wilderness": ["Meadow Snack Bar", "Trail\u2019s End Restaurant / P&J\u2019s Southern Takeout"], "Riverside": ["Riverside Mill Food Court"], "French Quarter": ["Sassagoula Floatworks & Food Factory"], "Saratoga Springs": ["The Artist\u2019s Palette", "The Paddock Grill"], "Animal Kingdom Lodge \u2013 Jambo": ["The Mara"], "Yacht Club": ["The Market at Ale & Compass"], "All\u2011Star Movies": ["World Premiere Food Court"]}, "Disney Springs": {"Disney Springs": ["4 Rivers Cantina Barbacoa Food Truck", "B.B. Wolf\u2019s Sausage Co.", "Blaze Fast\u2011Fire\u2019d Pizza", "Chicken Guy!", "Chicken Guy! To Go", "Cookes of Dublin", "D\u2011Luxe Burger", "Earl of Sandwich", "Earl of Sandwich Tavern", "Guy Fieri Flavortown Lounge Food Truck", "Morimoto Asia Street Food", "Pepe by Jos\u00e9 Andr\u00e9s", "Pizza Ponte", "Polite Pig", "The Daily Poutine"]}}, "Table Service": {"Park": {"Magic Kingdom": ["Be Our Guest Restaurant", "Cinderella\u2019s Royal Table", "Jungle Navigation Co. Skipper Canteen", "Liberty Tree Tavern", "The Beak and Barrel", "The Crystal Palace", "The Diamond Horseshoe", "The Plaza Restaurant", "Tony\u2019s Town Square Restaurant"], "EPCOT": ["Akershus Royal Banquet Hall", "Biergarten Restaurant", "Chefs de France", "Coral Reef Restaurant", "Garden Grill Restaurant", "La Cr\u00eaperie de Paris", "La Hacienda de San Angel", "Le Cellier Steakhouse", "Monsieur Paul", "Nine Dragons Restaurant", "Rose & Crown Dining Room", "San Angel Inn Restaurante", "Space 220 Restaurant", "Spice Road Table", "Teppan Edo", "Tokyo Dining", "Tutto Italia Ristorante", "Via Napoli Ristorante e Pizzeria"], "Hollywood Studios": ["50\u2019s Prime Time Caf\u00e9", "Hollywood & Vine", "Mama Melrose\u2019s Ristorante Italiano", "Roundup Rodeo BBQ", "Sci\u2011Fi Dine\u2011In Theater Restaurant", "The Hollywood Brown Derby"], "Animal Kingdom": ["Tiffins", "Yak & Yeti Restaurant"]}, "Resort": {"Polynesian": ["Kona Cafe", "Wailulu Bar & Grill", "\u2018Ohana"], "Grand Floridian": ["1900 Park Fare", "C\u00edtricos", "Grand Floridian Cafe", "Narcoossee\u2019s", "Victoria & Albert\u2019s"], "Yacht Club": ["Ale & Compass Restaurant", "Yachtsman Steakhouse"], "Beach Club": ["Beaches & Cream Soda Shop", "Cape May Cafe"], "Riverside": ["Boatwright\u2019s Dining Hall"], "Animal Kingdom Lodge \u2013 Jambo": ["Boma \u2013 Flavors of Africa", "Jiko \u2013 The Cooking Place"], "Contemporary": ["California Grill", "Chef Mickey\u2019s", "Steakhouse 71"], "BoardWalk": ["Flying Fish", "Trattoria al Forno"], "Fort Wilderness": ["Hoop\u2011Dee\u2011Doo Musical Revue"], "Coronado Springs": ["Maya Grill", "Three Bridges Bar and Grill", "Toledo \u2013 Tapas, Steak & Seafood"], "Old Key West": ["Olivia\u2019s Cafe"], "Animal Kingdom Lodge \u2013 Kidani": ["Sanaa"], "Caribbean Beach": ["Sebastian\u2019s Bistro"], "Wilderness Lodge": ["Story Book Dining at Artist Point with Snow White", "Whispering Canyon Cafe"], "Saratoga Springs": ["The Turf Club Bar and Grill"], "Riviera": ["Topolino\u2019s Terrace \u2013 Flavors of the Riviera"]}, "Disney Springs": {"Disney Springs": ["Chef Art Smith\u2019s Homecomin\u2019", "City Works Eatery & Pour House", "Enzo\u2019s Hideaway Tunnel Bar & Restaurant", "Frontera Cocina", "House of Blues Restaurant & Bar", "Jaleo by Jos\u00e9 Andr\u00e9s", "Maria & Enzo\u2019s Ristorante", "Morimoto Asia", "Paddlefish", "Paradiso 37, Taste of the Americas", "Planet Hollywood Observatory", "Raglan Road Irish Pub and Restaurant", "Rainforest Cafe at Disney Springs", "STK Orlando", "Splitsville Luxury Lanes Dining Room", "Summer House on the Lake", "Terralina Crafted Italian", "The BOATHOUSE", "The Edison", "T\u2011REX", "Wine Bar George \u2013 A Restaurant & Bar", "Wolfgang Puck Bar & Grill"]}}, "Snack": {"Park": {"Magic Kingdom": ["Adventureland Snack Cart (popcorn)", "Adventureland Spring Roll Cart", "Aloha Isle", "Big Thunder Mountain Popcorn Cart", "Castle Hub Popcorn & Ice Cream Cart", "Cheshire Caf\u00e9", "Cool Ship", "Doggone Good Dogs", "Energy Bytes", "Frontierland Popcorn", "Frontierland Turkey Leg Cart", "Golden Oak Outpost Ice Cream Cart", "Joffrey\u2019s Revive", "Liberty Square Market", "Main Street Confectionery", "Main Street Ice Cold Refreshment Cart", "Main Street Popcorn Carts (hub group)", "Pinocchio Village Haus Ice Cream Cart", "Plaza Ice Cream Parlor", "Prince Eric\u2019s Village Market", "Rocket Tower Plaza Ice Cream Cart", "Storybook Circus Popcorn & Ice Cream", "Storybook Circus Pretzels", "Storybook Treats", "Sunshine Tree Terrace"], "EPCOT": ["American Adventure Coffee Cart", "American Adventure Funnel Cakes", "Block & Hans", "Choza de Margarita", "Crepes \u00c0 Emporter", "Gelateria Toscana", "Joy of Tea", "Kabuki Caf\u00e9", "Katsura Grill Outdoor Sake/Kakigori Window", "Kringla Kiosk", "L\u2019Artisan des Glaces", "Mexico Margarita Stand", "Oasis Sips and Sweets", "Popcorn Carts", "Refreshment Outpost", "Refreshment Port", "The Land Cart (Land Kiosk)", "Yorkshire County Fish Shop"], "Hollywood Studios": ["Anaheim Produce", "Coke Bottle Cool Zone", "Dinosaur Gertie\u2019s Ice Cream of Extinction", "Hollywood Scoops", "Hub Popcorn Cart", "Kat Saka\u2019s Kettle", "Market Snack Kiosk", "Milk Stand", "Sunset Ranch Market", "The Market"], "Animal Kingdom": ["Anandapur Ice Cream Truck", "Beastly Kiosk", "Bradley Falls Kiosk", "Caravan Road", "Discovery Island Kiosk", "Drinkwallah", "Eight Spoon Caf\u00e9", "Harambe Market", "Isle of Java", "Mahindi", "Tamu Tamu Refreshments", "Terra Treats", "Warung Outpost"]}, "Resort": {}, "Disney Springs": {}}, "Bar": {"Park": {"Magic Kingdom": ["The Beak and Barrel Lounge Area"], "EPCOT": ["Germany Weinkeller", "La Cava del Tequila", "La Maison du Vin", "Rose & Crown Pub", "Space 220 Lounge", "Tutto Gusto Wine Cellar"], "Hollywood Studios": ["BaseLine Tap House", "Oga\u2019s Cantina", "Sunshine Day Bar", "The Hollywood Brown Derby Lounge", "Tune\u2011In Lounge"], "Animal Kingdom": ["Dawa Bar", "Nomad Lounge", "Thirsty River Bar & Trek Snacks"]}, "Resort": {"BoardWalk": ["AbracadaBar", "Belle Vue Lounge"], "Yacht Club": ["Ale & Compass Lounge", "Crew\u2019s Cup Lounge"], "Saratoga Springs": ["Backstretch Pool Bar", "On the Rocks"], "Caribbean Beach": ["Banana Cabana"], "Coronado Springs": ["Barcelona Lounge", "Dahlia Lounge", "Rix Sports Bar & Grill"], "Contemporary": ["California Grill Lounge", "Outer Rim Lounge", "Steakhouse 71 Lounge"], "Animal Kingdom Lodge \u2013 Jambo": ["Cape Town Lounge & Wine Bar", "Uzima Springs Pool Bar", "Victoria Falls Lounge"], "Grand Floridian": ["Courtyard Pool Bar", "Enchanted Rose Lounge"], "Fort Wilderness": ["Crockett\u2019s Tavern"], "All\u2011Star Sports": ["Grandstand Spirits"], "Old Key West": ["Gurgling Suitcase"], "Animal Kingdom Lodge \u2013 Kidani": ["Maji Pool Bar", "Sanaa Lounge"], "Beach Club": ["Martha\u2019s Vineyard Lounge"], "Riverside": ["Muddy Rivers Pool Bar", "River Roost Lounge"], "Pop Century": ["Petals Pool Bar"], "French Quarter": ["Scat Cat\u2019s Club \u2013 Lounge"], "All\u2011Star Movies": ["Silver Screen Spirits Bar"], "All\u2011Star Music": ["Singing Spirits Bar"], "Polynesian": ["Tambu Lounge", "Trader Sam\u2019s Grog Grotto", "Trader Sam\u2019s Tiki Terrace"], "Wilderness Lodge": ["Territory Lounge"], "Art of Animation": ["The Drop Off Pool Bar"], "Riviera": ["Voyageurs\u2019 Lounge"]}, "Disney Springs": {"Disney Springs": ["Dockside Margaritas", "Enzo\u2019s Hideaway Tunnel Bar", "House of Blues Front Porch Bar", "Jock Lindsey\u2019s Hangar Bar", "Paddlefish Rooftop Bar", "Raglan Road Bar (inside & exterior patio bar)", "STK Orlando Rooftop Bar", "Splitsville Bar", "Stargazers Bar (at Planet Hollywood, when operating seasonally)", "The BOATHOUSE Bars (indoor & Dockside)", "The Edison Bar", "Wine Bar George \u2013 Wine Bar"]}}};

    let data = { contracts: [], trips: [], plans: {}, lastSync: "" };
    let currentEditDate = null;
    let planViewMode = 'view';

    async function init() {
        try {
            const res = await fetch(URL + '/latest', { headers: { 'X-Master-Key': API_KEY } });
            const cloud = await res.json();
            data = cloud.record || cloud;
            if(!data.plans) data.plans = {};
            render();
            updatePlanDropdown();
        } catch (e) { 
            const backup = localStorage.getItem('dvc_data_final');
            if(backup) { data = JSON.parse(backup); render(); updatePlanDropdown(); }
        }
    }

    function showTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    function updatePlanDropdown() {
        const sel = document.getElementById('planTripSelect');
        if(!sel) return;
        sel.innerHTML = '<option value="" disabled selected>Select a Trip</option>';
        if(data.trips) data.trips.forEach(t => sel.innerHTML += `<option value="${t.id}">${t.name}</option>`);
    }

    function initPlanView() {
        const tId = document.getElementById('planTripSelect').value;
        const trip = data.trips.find(t => t.id == tId);
        if(!trip) return;
        currentEditDate = trip.start;
        document.getElementById('planArea').style.display = 'block';
        refreshEditHeader();
        loadItinerary();
    }

    function setPlanMode(mode) {
        planViewMode = mode;
        document.getElementById('viewBtn').classList.toggle('active', mode === 'view');
        document.getElementById('editBtn').classList.toggle('active', mode === 'edit');
        document.getElementById('creationStation').style.display = (mode === 'edit' ? 'block' : 'none');
        document.getElementById('itineraryDisplay').style.display = (mode === 'view' ? 'block' : 'none');
        if(mode === 'edit') { toggleFormMenus(); refreshEditHeader(); }
        loadItinerary();
    }

    function changeDate(dir) {
        const tId = document.getElementById('planTripSelect').value;
        const trip = data.trips.find(t => t.id == tId);
        let d = new Date(currentEditDate + "T00:00:00");
        d.setDate(d.getDate() + dir);
        let newStr = d.toISOString().split('T')[0];
        if (newStr >= trip.start && newStr <= trip.end) {
            currentEditDate = newStr;
            refreshEditHeader();
        }
    }

    // --- DAY THEME LOGIC ---
    function refreshEditHeader() {
        const tId = document.getElementById('planTripSelect').value;
        const dateObj = new Date(currentEditDate + "T00:00:00");
        document.getElementById('displayDateText').innerText = dateObj.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'});
        
        const config = data.plans[tId]?.days?.[currentEditDate] || { type: '', location: '' };
        document.getElementById('dayTypeSelect').value = config.type;
        updateDayTheme('type', config.type, true);
    }

    function updateDayTheme(key, val, isInitial = false) {
        const tId = document.getElementById('planTripSelect').value;
        if(!data.plans[tId]) data.plans[tId] = { days: {} };
        if(!data.plans[tId].days) data.plans[tId].days = {};
        if(!data.plans[tId].days[currentEditDate]) data.plans[tId].days[currentEditDate] = { type: '', location: '' };
        
        if(!isInitial) {
            data.plans[tId].days[currentEditDate][key] = val;
            if(key === 'type') data.plans[tId].days[currentEditDate].location = '';
        }

        const type = data.plans[tId].days[currentEditDate].type;
        const locVal = data.plans[tId].days[currentEditDate].location;
        const wrapper = document.getElementById('dayLocWrapper');
        
        if(!type) { wrapper.innerHTML = ""; return; }
        
        const parks = ["Magic Kingdom", "EPCOT", "Hollywood Studios", "Animal Kingdom"].sort();
        const resorts = ["Animal Kingdom Lodge", "Aulani", "Bay Lake Tower", "Beach Club", "BoardWalk", "Boulder Ridge", "Copper Creek", "Fort Wilderness", "Grand Californian", "Grand Floridian", "Hilton Head Island", "Old Key West", "Polynesian", "Riviera", "Saratoga Springs", "Vero Beach", "Wilderness Lodge", "Yacht Club"].sort();
        const list = type === 'Park Day' ? parks : resorts;

        wrapper.innerHTML = `<label>Specific Location</label><select onchange="updateDayTheme('location', this.value)"><option value="">-- Select --</option>${list.map(l => `<option value="${l}" ${l === locVal ? 'selected' : ''}>${l}</option>`).join('')}</select>`;
    }

    // --- ACTIVITY LOGIC ---
    function toggleFormMenus() {
        const type = document.getElementById('newType').value;
        document.getElementById('diningLogic').style.display = (type === 'Dining' ? 'block' : 'none');
        document.getElementById('otherDetails').style.display = (type !== 'Dining' ? 'block' : 'none');
        if(type === 'Dining') {
            const srvSel = document.getElementById('newDiningSrv');
            const sortedSrv = Object.keys(diningDatabase).sort();
            srvSel.innerHTML = '<option value="">-- Service Type --</option>' + sortedSrv.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('catWrapper').innerHTML = '';
            document.getElementById('locWrapper').innerHTML = '';
            document.getElementById('venueWrapper').innerHTML = '';
        }
    }

    function updateDiningCategory() {
        const srv = document.getElementById('newDiningSrv').value;
        const wrapper = document.getElementById('catWrapper');
        const sortedCats = srv ? Object.keys(diningDatabase[srv]).sort() : [];
        wrapper.innerHTML = srv ? `<label>Category</label><select id="newCat" onchange="updateDiningLocation()"><option value="">-- Choose Category --</option>${sortedCats.map(c => `<option value="${c}">${c}</option>`).join('')}</select>` : '';
        document.getElementById('locWrapper').innerHTML = '';
        document.getElementById('venueWrapper').innerHTML = '';
    }

    function updateDiningLocation() {
        const srv = document.getElementById('newDiningSrv').value;
        const cat = document.getElementById('newCat').value;
        const wrapper = document.getElementById('locWrapper');
        const sortedLocs = cat ? Object.keys(diningDatabase[srv][cat]).sort() : [];
        wrapper.innerHTML = cat ? `<label>Location</label><select id="newLoc" onchange="updateDiningVenue()"><option value="">-- Choose Location --</option>${sortedLocs.map(l => `<option value="${l}">${l}</option>`).join('')}</select>` : '';
        document.getElementById('venueWrapper').innerHTML = '';
    }

    function updateDiningVenue() {
        const srv = document.getElementById('newDiningSrv').value;
        const cat = document.getElementById('newCat').value;
        const loc = document.getElementById('newLoc').value;
        const wrapper = document.getElementById('venueWrapper');
        const sortedVenues = loc ? diningDatabase[srv][cat][loc].sort() : [];
        wrapper.innerHTML = loc ? `<label>Venue</label><select id="newVenue"><option value="">-- Choose Venue --</option>${sortedVenues.map(v => `<option value="${v}">${v}</option>`).join('')}</select>` : '';
    }

    function addPlanFromForm() {
        const tId = document.getElementById('planTripSelect').value;
        const type = document.getElementById('newType').value;
        const start = document.getElementById('newStartTime').value;
        const end = document.getElementById('newEndTime').value;
        let desc = document.getElementById('newDesc').value;
        let selection = "";
        if(type === 'Dining') {
            selection = document.getElementById('newVenue')?.value || "";
            if(!selection) { alert("Select a venue!"); return; }
        } else if(!desc) { alert("Enter details!"); return; }
        
        const key = currentEditDate + "_acts";
        if(!data.plans[tId]) data.plans[tId] = {};
        if(!data.plans[tId][key]) data.plans[tId][key] = [];
        data.plans[tId][key].push({ type, start, end, desc, selection });
        
        document.getElementById('newStartTime').value = '';
        document.getElementById('newEndTime').value = '';
        document.getElementById('newDesc').value = '';
        toggleFormMenus();
        alert("Plan added to itinerary!");
    }

    function loadItinerary() {
        const tId = document.getElementById('planTripSelect').value;
        const trip = data.trips.find(t => t.id == tId);
        const container = document.getElementById('itineraryDisplay');
        container.innerHTML = '';
        if(!trip) return;
        let start = new Date(trip.start + "T00:00:00");
        let end = new Date(trip.end + "T00:00:00");
        while(start <= end) {
            const ds = start.toISOString().split('T')[0];
            const acts = data.plans[tId]?.[ds + "_acts"] || [];
            const config = data.plans[tId]?.days?.[ds] || { type: '', location: '' };
            
            let card = document.createElement('div');
            card.className = 'plan-day-card';
            let html = `<h4>${start.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'})}</h4>`;
            
            if(config.type && config.location) {
                html += `<div class="view-theme-label">${config.type === 'Park Day' ? 'üé°' : 'üèä'} ${config.location}</div>`;
            }
            
            let autoLabel = (ds === trip.start) ? `üè® Checking into ${trip.resort}` : 
                            (ds === trip.end) ? `üè® Checking out of ${trip.resort}` : `üè® Staying at ${trip.resort}`;
            html += `<div class="auto-tag">${autoLabel}</div>`;

            acts.sort((a,b) => (a.start || "").localeCompare(b.start || "")).forEach((a, i) => {
                html += `<div class="view-item"><div class="view-time">${formatTime(a.start)}${a.end ? ' - ' + formatTime(a.end) : ''}</div><div class="view-desc"><strong>${a.selection || a.desc}</strong><br><small>${a.type}</small></div><span class="trash-btn" onclick="deleteItem('${tId}','${ds}',${i})">üóëÔ∏è</span></div>`;
            });
            card.innerHTML = html; container.appendChild(card); start.setDate(start.getDate() + 1);
        }
    }

    function deleteItem(tId, date, idx) {
        if(confirm("Remove?")) { data.plans[tId][date + "_acts"].splice(idx, 1); loadItinerary(); }
    }

    function formatTime(t) {
        if(!t) return "";
        const [h, m] = t.split(':');
        return ((h % 12) || 12) + ":" + m + (h >= 12 ? ' PM' : ' AM');
    }

    // --- DASHBOARD & CONTRACTS ---
    function render() {
        const summary = document.getElementById('contractSummary');
        const editor = document.getElementById('contractEditor');
        const nextTripDiv = document.getElementById('nextTripDisplay');
        const tripList = document.getElementById('tripManager');
        let totalPts = 0;
        summary.innerHTML = ''; editor.innerHTML = ''; nextTripDiv.innerHTML = ''; tripList.innerHTML = '';

        data.contracts.forEach(c => {
            let used = (c.used || 0);
            let remBanked = Math.max(0, (c.banked || 0) - used);
            used = Math.max(0, used - (c.banked || 0));
            let remCur = Math.max(0, c.annual - used);
            let remFut = Math.max(0, c.annual - (c.borrowed || 0));
            totalPts += (remBanked + remCur + remFut);
            summary.innerHTML += `<div class="dashboard-contract-card"><div class="card-header"><span>${c.resort}</span></div><div class="point-grid"><div class="point-box"><span class="point-val">${remBanked}</span><span class="point-label">Banked</span></div><div class="point-box"><span class="point-val">${remCur}</span><span class="point-label">Current</span></div><div class="point-box"><span class="point-val">${remFut}</span><span class="point-label">Future</span></div></div></div>`;
            editor.innerHTML += `<div class="dashboard-contract-card" style="padding:15px;"><div style="display:flex; justify-content:space-between"><strong>${c.resort}</strong><span style="color:red; cursor:pointer" onclick="deleteContract(${c.id})">Delete</span></div><div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; margin-top:10px"><span>Banked<br><input type="number" value="${c.banked}" onchange="updateContract(${c.id}, 'banked', this.value)"></span><span>Annual<br><input type="number" value="${c.annual}" disabled></span><span>Borrow<br><input type="number" value="${c.borrowed}" onchange="updateContract(${c.id}, 'borrowed', this.value)"></span></div><div style="text-align:right; margin-top:10px;">Used: <input type="number" style="width:80px; text-align:center;" value="${c.used}" onchange="updateContract(${c.id}, 'used', this.value)"></div></div>`;
        });
        document.getElementById('grandTotal').innerText = `TOTAL: ${totalPts} PTS`;
        const sorted = (data.trips || []).sort((a,b) => new Date(a.start + "T00:00:00") - new Date(b.start + "T00:00:00"));
        const today = new Date(); today.setHours(0,0,0,0);
        sorted.forEach((t, idx) => {
            const s = new Date(t.start + "T00:00:00");
            const e = new Date(t.end + "T00:00:00");
            if (idx === 0 && today <= e) {
                let status = (today < s) ? `${Math.ceil((s - today) / (1000*60*60*24))} DAYS UNTIL` : "WELCOME HOME!";
                nextTripDiv.innerHTML = `<div class="trip-card"><div><strong>${t.name}</strong><br><small>${t.resort}</small></div><div>${status}</div></div>`;
            }
            tripList.innerHTML += `<div class="trip-card"><div>${t.name} (${t.start})</div><button onclick="deleteTrip(${t.id})" style="background:none;border:none;color:red;font-weight:bold;">X</button></div>`;
        });
        document.getElementById('lastSync').innerText = "Last Sync: " + (data.lastSync || "Check Sync Status");
    }

    async function saveToCloud() {
        data.lastSync = new Date().toLocaleString();
        try {
            await fetch(URL, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY }, body: JSON.stringify(data) });
            localStorage.setItem('dvc_data_final', JSON.stringify(data));
            render(); alert("Saved!");
        } catch (e) { alert("Sync failed"); }
    }

    function addTrip() {
        const name = document.getElementById('tripName').value;
        const resort = document.getElementById('tripResort').value;
        const start = document.getElementById('checkIn').value;
        const end = document.getElementById('checkOut').value;
        if(!name || !resort || !start || !end) return;
        data.trips.push({ id: Date.now(), name, resort, start, end });
        render(); updatePlanDropdown();
    }

    function updateContract(id, key, val) { const idx = data.contracts.findIndex(c => c.id === id); data.contracts[idx][key] = parseInt(val) || 0; render(); }
    function deleteTrip(id) { if(confirm("Delete trip?")) { data.trips = data.trips.filter(t => t.id !== id); render(); updatePlanDropdown(); } }
    function deleteContract(id) { if(confirm("Delete?")) { data.contracts = data.contracts.filter(c => c.id !== id); render(); } }

    init();
</script>
</body>
</html>
