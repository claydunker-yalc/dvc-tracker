<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DVC Master Tracker</title>
    <style>
        @font-face { font-family: 'DisneyMagic'; src: url('waltograph42.ttf'); }
        @font-face { font-family: 'UniversBold'; src: url('SNBold.ttf'); }
        @font-face { font-family: 'UniversRegular'; src: url('SNRegular.ttf'); }

        :root {
            --sign-purple: #3b1660; --sign-red: #d31130; --sign-yellow: #fff200; 
            --sign-blue: #0072bc; --sign-white: #ffffff;
        }

        body {
            background: url('background.png') no-repeat center bottom fixed;
            background-size: cover; font-family: 'UniversRegular', sans-serif;
            display: flex; flex-direction: column; align-items: center; padding-bottom: 80px; margin: 0;
        }

        .spacer-top { height: 12vh; width: 100%; flex-shrink: 0; }

        .sign-container {
            max-width: 650px; width: 95%; background-color: var(--sign-purple); color: var(--sign-white);
            border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.8); border: 6px solid #333;
            display: flex; flex-direction: column; overflow: hidden;
        }

        header { padding: 20px; text-align: center; }
        h1 { font-family: 'DisneyMagic', cursive; margin: 0; font-size: 3rem; color: var(--sign-white); text-shadow: 3px 3px 0px var(--sign-blue); }
        .welcome-msg { font-family: 'UniversBold'; color: var(--sign-yellow); letter-spacing: 3px; font-size: 1.1rem; text-transform: uppercase; margin-top: 5px; }

        .tabs { display: flex; background: rgba(0,0,0,0.4); border-top: 4px solid var(--sign-red); border-bottom: 4px solid var(--sign-red); overflow-x: auto; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; color: white; font-family: 'UniversBold'; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; min-width: 90px; }
        .tab-btn.active { background: var(--sign-red); color: var(--sign-yellow); }

        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }

        /* Dashboard & General Cards */
        .dashboard-contract-card { background: white; color: #333; border-radius: 8px; margin-bottom: 15px; border-left: 12px solid var(--sign-blue); box-shadow: 0 4px 10px rgba(0,0,0,0.3); overflow: hidden; }
        .card-header { padding: 10px 15px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-weight: bold; }
        .point-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; text-align: center; padding: 12px 5px; }
        .point-val { font-family: 'UniversBold'; font-size: 1.3rem; color: var(--sign-purple); display: block; }
        .point-label { font-size: 0.6rem; color: #666; text-transform: uppercase; }
        .expiration-alert { background: #fff3cd; color: #856404; font-size: 0.7rem; padding: 8px; text-align: center; font-family: 'UniversBold'; border-top: 1px solid #ffeeba; }

        /* Date Nav Bar (Edit View) */
        .date-nav-bar {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--sign-white); color: var(--sign-purple);
            border-radius: 8px; margin-bottom: 15px; padding: 8px;
        }
        .nav-arrow { background: var(--sign-blue); color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer; font-family: 'UniversBold'; font-size: 1.2rem; }
        .nav-arrow:disabled { background: #ccc; cursor: not-allowed; }
        .current-date-display { flex-grow: 1; text-align: center; font-family: 'UniversBold'; font-size: 1.1rem; cursor: pointer; }
        .hidden-date-input { position: absolute; opacity: 0; pointer-events: none; }

        /* Plan Cards */
        .plan-day-card { background: white; color: #333; border-radius: 8px; padding: 15px; border-left: 10px solid var(--sign-red); box-shadow: 0 4px 10px rgba(0,0,0,0.2); margin-bottom: 15px; }
        .plan-day-card h4 { margin: 0 0 10px 0; color: var(--sign-purple); font-family: 'UniversBold'; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .activity-row { background: #f1f1f1; border: 1px solid #ccc; border-radius: 6px; padding: 12px; margin-bottom: 12px; position: relative; }
        .time-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .smart-dropdowns { display: flex; flex-direction: column; gap: 8px; }
        .del-act-btn { position: absolute; top: 5px; right: 8px; color: red; font-weight: bold; cursor: pointer; font-size: 1.2rem; }
        
        input, select { padding: 10px; border-radius: 4px; border: 1px solid #ccc; width: 100%; font-family: 'UniversRegular'; box-sizing: border-box; }
        label { font-size: 0.65rem; font-family: 'UniversBold'; color: var(--sign-purple); text-transform: uppercase; display: block; margin-top: 5px; }

        .disney-button { background: var(--sign-yellow); color: #333; border: none; padding: 15px; font-family: 'UniversBold'; cursor: pointer; text-transform: uppercase; width: 100%; border-radius: 4px; margin-bottom: 10px; }
        .sync-btn { background: var(--sign-red); color: white; border: 3px solid var(--sign-yellow); margin-top: 10px; }
        
        .view-item { padding: 10px; border-bottom: 1px dashed #ccc; display: flex; align-items: baseline; }
        .view-time { color: var(--sign-blue); font-family: 'UniversBold'; min-width: 100px; font-size: 0.85rem; }
        .view-desc { font-size: 0.95rem; }
        .trip-card { background: var(--sign-yellow); color: #222; padding: 12px; border-radius: 4px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-family: 'UniversBold'; }

        .footer-red { background-color: var(--sign-red); padding: 18px 10px; text-align: center; font-family: 'UniversBold'; color: var(--sign-yellow); text-transform: uppercase; border-top: 4px solid var(--sign-yellow); letter-spacing: 2px; }
        .sync-stamp { display: block; font-size: 0.65rem; margin-top: 6px; color: var(--sign-white); text-transform: none; letter-spacing: normal; opacity: 0.9; }
    </style>
</head>
<body>

<div class="spacer-top"></div>

<div class="sign-container">
    <header>
        <h1>Dvc Point Tracker</h1>
        <div class="welcome-msg">WELCOME HOME DUNKER FAMILY!</div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('home')">Dashboard</button>
        <button class="tab-btn" onclick="showTab('plans')">Plans</button>
        <button class="tab-btn" onclick="showTab('trips')">Trips</button>
        <button class="tab-btn" onclick="showTab('settings')">Contracts</button>
    </div>

    <div id="home" class="tab-content active">
        <div id="grandTotal" style="font-size: 2.5rem; color: var(--sign-yellow); text-align: center; margin-bottom: 20px; font-family: 'UniversBold';">TOTAL: 0 PTS</div>
        <div id="nextTripDisplay"></div>
        <h3 style="border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 8px;">REMAINING BY CYCLE</h3>
        <div id="contractSummary"></div>
    </div>

    <div id="plans" class="tab-content">
        <select id="planTripSelect" onchange="initPlanView()" style="margin-bottom:15px;"></select>
        
        <div id="planArea" style="display:none;">
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <button id="viewBtn" class="tab-btn active" style="font-size:0.7rem; min-width:unset; background:rgba(0,0,0,0.3)" onclick="setPlanMode('view')">View Itinerary</button>
                <button id="editBtn" class="tab-btn" style="font-size:0.7rem; min-width:unset; background:rgba(0,0,0,0.3)" onclick="setPlanMode('edit')">Edit Day-by-Day</button>
            </div>

            <div id="editNavArea" style="display:none;">
                <div class="date-nav-bar">
                    <button id="prevDate" class="nav-arrow" onclick="changeDate(-1)">❮</button>
                    <div class="current-date-display" onclick="triggerDatePicker()">
                        <span id="displayDateText">Date</span>
                        <input type="date" id="jumpDatePicker" class="hidden-date-input" onchange="jumpToDate(this.value)">
                    </div>
                    <button id="nextDate" class="nav-arrow" onclick="changeDate(1)">❯</button>
                </div>
            </div>

            <div id="planDayContainer"></div>
            <button class="disney-button sync-btn" onclick="saveToCloud()">Push Plans to Cloud</button>
        </div>
    </div>

    <div id="trips" class="tab-content">
        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px;">
            <input type="text" id="tripName" placeholder="Trip Name">
            <select id="tripResort" style="margin: 10px 0;">
                <option value="" disabled selected>Select Resort</option>
                <option value="Animal Kingdom Lodge">Animal Kingdom Lodge</option>
                <option value="Beach Club">Beach Club</option>
                <option value="Old Key West">Old Key West</option>
                <option value="Polynesian">Polynesian</option>
                <option value="Riviera">Riviera</option>
                <option value="Saratoga Springs">Saratoga Springs</option>
                <option value="Vero Beach">Vero Beach</option>
            </select>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                <input type="date" id="checkIn">
                <input type="date" id="checkOut">
            </div>
            <button class="disney-button" onclick="addTrip()">Add Trip</button>
        </div>
        <div id="tripManager" style="margin-top:20px;"></div>
    </div>

    <div id="settings" class="tab-content">
        <div id="contractEditor"></div>
        <button class="disney-button sync-btn" onclick="saveToCloud()">Push to Cloud</button>
    </div>

    <div class="footer-red">
        THE MOST MAGICAL PLACE ON EARTH
        <div id="lastSync" class="sync-stamp">Initializing Cloud...</div>
    </div>
</div>

<script>
    // --- DATABASE ---
    const diningDatabase = {"Quick Service": {"Park": {"Magic Kingdom": ["Casey\u2019s Corner", "Columbia Harbour House", "Cosmic Ray\u2019s Starlight Caf\u00e9", "Friar\u2019s Nook", "Gaston\u2019s Tavern", "Golden Oak Outpost", "Main Street Bakery (Starbucks)", "Pecos Bill Tall Tale Inn and Cafe", "Pinocchio Village Haus", "Sleepy Hollow", "The Lunching Pad", "Tomorrowland Terrace (when operating)"], "EPCOT": ["Connections Caf\u00e9 (Starbucks)", "Connections Eatery", "Cr\u00eapes \u00c0 Emporter", "Katsura Grill", "Kringla Bakeri Og Kafe", "La Cantina de San Angel", "Les Halles Boulangerie\u2011Patisserie", "Regal Eagle Smokehouse", "Sommerfest", "Sunshine Seasons", "Yorkshire County Fish Shop"], "Hollywood Studios": ["ABC Commissary", "Backlot Express", "Catalina Eddie\u2019s", "Docking Bay 7 Food and Cargo", "Fairfax Fare", "PizzeRizzo", "Ronto Roasters", "Rosie\u2019s All\u2011American Caf\u00e9", "Woody\u2019s Lunch Box"], "Animal Kingdom": ["Flame Tree Barbecue", "Harambe Market", "Pizzafari", "Restaurantosaurus", "Satu\u2019li Canteen", "Yak & Yeti Local Food Cafes"]}, "Resort": {"Disney\u2019s Riviera Resort": ["Bar Riva", "Le Petit Caf\u00e9", "Primo Piatto"], "Disney\u2019s Beach Club Resort": ["Beach Club Marketplace", "Hurricane Hanna\u2019s Waterside Bar & Grill"], "Disney\u2019s Grand Floridian Resort": ["Beaches Pool Bar & Grill", "Gasparilla Island Grill"], "Disney\u2019s BoardWalk Inn": ["BoardWalk Deli"], "Disney\u2019s Coronado Springs Resort": ["Caf\u00e9 Rix", "El Mercado de Coronado"], "Disney\u2019s Polynesian Village Resort": ["Capt. Cook\u2019s", "Oasis Bar & Grill"], "Disney\u2019s Caribbean Beach Resort": ["Centertown Market", "Spyglass Grill"], "Disney\u2019s Contemporary Resort": ["Contempo Caf\u00e9", "Sand Bar"], "Disney\u2019s All\u2011Star Sports Resort": ["End Zone Food Court"], "Disney\u2019s Pop Century Resort": ["Everything POP Dining"], "Disney\u2019s Wilderness Lodge": ["Geyser Point Bar & Grill", "Roaring Fork"], "Disney\u2019s Old Key West Resort": ["Good\u2019s Food to Go"], "Disney\u2019s All\u2011Star Music Resort": ["Intermission Food Court"], "Disney\u2019s Art of Animation Resort": ["Landscape of Flavors"], "Disney\u2019s Fort Wilderness Resort & Campground": ["Meadow Snack Bar", "Trail\u2019s End Restaurant / P&J\u2019s Southern Takeout"], "Disney\u2019s Port Orleans Resort \u2013 Riverside": ["Riverside Mill Food Court"], "Disney\u2019s Port Orleans Resort \u2013 French Quarter": ["Sassagoula Floatworks & Food Factory"], "Disney\u2019s Saratoga Springs Resort": ["The Artist\u2019s Palette", "The Paddock Grill"], "Disney\u2019s Animal Kingdom Lodge \u2013 Jambo": ["The Mara"], "Disney\u2019s Yacht Club Resort": ["The Market at Ale & Compass"], "Disney\u2019s All\u2011Star Movies Resort": ["World Premiere Food Court"]}, "Disney Springs": {"Disney Springs": ["4 Rivers Cantina Barbacoa Food Truck", "B.B. Wolf\u2019s Sausage Co.", "Blaze Fast\u2011Fire\u2019d Pizza", "Chicken Guy!", "Chicken Guy! To Go", "Cookes of Dublin", "D\u2011Luxe Burger", "Earl of Sandwich", "Earl of Sandwich Tavern", "Guy Fieri Flavortown Lounge Food Truck", "Morimoto Asia Street Food", "Pepe by Jos\u00e9 Andr\u00e9s", "Pizza Ponte", "Polite Pig", "The Daily Poutine"]}}, "Table Service": {"Park": {"Magic Kingdom": ["Be Our Guest Restaurant", "Cinderella\u2019s Royal Table", "Jungle Navigation Co. Skipper Canteen", "Liberty Tree Tavern", "The Beak and Barrel", "The Crystal Palace", "The Diamond Horseshoe", "The Plaza Restaurant", "Tony\u2019s Town Square Restaurant"], "EPCOT": ["Akershus Royal Banquet Hall", "Biergarten Restaurant", "Chefs de France", "Coral Reef Restaurant", "Garden Grill Restaurant", "La Cr\u00eaperie de Paris", "La Hacienda de San Angel", "Le Cellier Steakhouse", "Monsieur Paul", "Nine Dragons Restaurant", "Rose & Crown Dining Room", "San Angel Inn Restaurante", "Space 220 Restaurant", "Spice Road Table", "Teppan Edo", "Tokyo Dining", "Tutto Italia Ristorante", "Via Napoli Ristorante e Pizzeria"], "Hollywood Studios": ["50\u2019s Prime Time Caf\u00e9", "Hollywood & Vine", "Mama Melrose\u2019s Ristorante Italiano", "Roundup Rodeo BBQ", "Sci\u2011Fi Dine\u2011In Theater Restaurant", "The Hollywood Brown Derby"], "Animal Kingdom": ["Tiffins", "Yak & Yeti Restaurant"]}, "Resort": {"Disney\u2019s Polynesian Village Resort": ["Kona Cafe", "Wailulu Bar & Grill", "\u2018Ohana"], "Disney\u2019s Grand Floridian Resort": ["1900 Park Fare", "C\u00edtricos", "Grand Floridian Cafe", "Narcoossee\u2019s", "Victoria & Albert\u2019s"], "Disney\u2019s Yacht Club Resort": ["Ale & Compass Restaurant", "Yachtsman Steakhouse"], "Disney\u2019s Beach Club Resort": ["Beaches & Cream Soda Shop", "Cape May Cafe"], "Disney\u2019s Port Orleans Resort \u2013 Riverside": ["Boatwright\u2019s Dining Hall"], "Disney\u2019s Animal Kingdom Lodge \u2013 Jambo": ["Boma \u2013 Flavors of Africa", "Jiko \u2013 The Cooking Place"], "Disney\u2019s Contemporary Resort": ["California Grill", "Chef Mickey\u2019s", "Steakhouse 71"], "Disney\u2019s BoardWalk Inn": ["Flying Fish", "Trattoria al Forno"], "Disney\u2019s Fort Wilderness Resort & Campground": ["Hoop\u2011Dee\u2011Doo Musical Revue"], "Disney\u2019s Coronado Springs Resort": ["Maya Grill", "Three Bridges Bar and Grill", "Toledo \u2013 Tapas, Steak & Seafood"], "Disney\u2019s Old Key West Resort": ["Olivia\u2019s Cafe"], "Disney\u2019s Animal Kingdom Lodge \u2013 Kidani": ["Sanaa"], "Disney\u2019s Caribbean Beach Resort": ["Sebastian\u2019s Bistro"], "Disney\u2019s Wilderness Lodge": ["Story Book Dining at Artist Point with Snow White", "Whispering Canyon Cafe"], "Disney\u2019s Saratoga Springs Resort": ["The Turf Club Bar and Grill"], "Disney\u2019s Riviera Resort": ["Topolino\u2019s Terrace \u2013 Flavors of the Riviera"]}, "Disney Springs": {"Disney Springs": ["Chef Art Smith\u2019s Homecomin\u2019", "City Works Eatery & Pour House", "Enzo\u2019s Hideaway Tunnel Bar & Restaurant", "Frontera Cocina", "House of Blues Restaurant & Bar", "Jaleo by Jos\u00e9 Andr\u00e9s", "Maria & Enzo\u2019s Ristorante", "Morimoto Asia", "Paddlefish", "Paradiso 37, Taste of the Americas", "Planet Hollywood Observatory", "Raglan Road Irish Pub and Restaurant", "Rainforest Cafe at Disney Springs", "STK Orlando", "Splitsville Luxury Lanes Dining Room", "Summer House on the Lake", "Terralina Crafted Italian", "The BOATHOUSE", "The Edison", "T\u2011REX", "Wine Bar George \u2013 A Restaurant & Bar", "Wolfgang Puck Bar & Grill"]}}, "Snack": {"Park": {"Magic Kingdom": ["Adventureland Snack Cart (popcorn)", "Adventureland Spring Roll Cart", "Aloha Isle", "Big Thunder Mountain Popcorn Cart", "Castle Hub Popcorn & Ice Cream Cart", "Cheshire Caf\u00e9", "Cool Ship", "Doggone Good Dogs", "Energy Bytes", "Frontierland Popcorn", "Frontierland Turkey Leg Cart", "Golden Oak Outpost Ice Cream Cart", "Joffrey\u2019s Revive", "Liberty Square Market", "Main Street Confectionery", "Main Street Ice Cold Refreshment Cart", "Main Street Popcorn Carts (hub group)", "Pinocchio Village Haus Ice Cream Cart", "Plaza Ice Cream Parlor", "Prince Eric\u2019s Village Market", "Rocket Tower Plaza Ice Cream Cart", "Storybook Circus Popcorn & Ice Cream", "Storybook Circus Pretzels", "Storybook Treats", "Sunshine Tree Terrace"], "EPCOT": ["American Adventure Coffee Cart", "American Adventure Funnel Cakes", "Block & Hans", "Choza de Margarita", "Crepes \u00c0 Emporter", "Gelateria Toscana", "Joy of Tea", "Kabuki Caf\u00e9", "Katsura Grill Outdoor Sake/Kakigori Window", "Kringla Kiosk", "L\u2019Artisan des Glaces", "Mexico Margarita Stand", "Oasis Sips and Sweets", "Popcorn Carts", "Refreshment Outpost", "Refreshment Port", "The Land Cart (Land Kiosk)", "Yorkshire County Fish Shop"], "Hollywood Studios": ["Anaheim Produce", "Coke Bottle Cool Zone", "Dinosaur Gertie\u2019s Ice Cream of Extinction", "Hollywood Scoops", "Hub Popcorn Cart", "Kat Saka\u2019s Kettle", "Market Snack Kiosk", "Milk Stand", "Sunset Ranch Market", "The Market"], "Animal Kingdom": ["Anandapur Ice Cream Truck", "Beastly Kiosk", "Bradley Falls Kiosk", "Caravan Road", "Discovery Island Kiosk", "Drinkwallah", "Eight Spoon Caf\u00e9", "Harambe Market", "Isle of Java", "Mahindi", "Tamu Tamu Refreshments", "Terra Treats", "Warung Outpost"]}, "Resort": {}, "Disney Springs": {}}, "Bar": {"Park": {"Magic Kingdom": ["The Beak and Barrel Lounge Area"], "EPCOT": ["Germany Weinkeller", "La Cava del Tequila", "La Maison du Vin", "Rose & Crown Pub", "Space 220 Lounge", "Tutto Gusto Wine Cellar"], "Hollywood Studios": ["BaseLine Tap House", "Oga\u2019s Cantina", "Sunshine Day Bar", "The Hollywood Brown Derby Lounge", "Tune\u2011In Lounge"], "Animal Kingdom": ["Dawa Bar", "Nomad Lounge", "Thirsty River Bar & Trek Snacks"]}, "Resort": {"Disney\u2019s BoardWalk Inn": ["AbracadaBar", "Belle Vue Lounge"], "Disney\u2019s Yacht Club Resort": ["Ale & Compass Lounge", "Crew\u2019s Cup Lounge"], "Disney\u2019s Saratoga Springs Resort": ["Backstretch Pool Bar", "On the Rocks"], "Disney\u2019s Caribbean Beach Resort": ["Banana Cabana"], "Disney\u2019s Coronado Springs Resort": ["Barcelona Lounge", "Dahlia Lounge", "Rix Sports Bar & Grill"], "Disney\u2019s Contemporary Resort": ["California Grill Lounge", "Outer Rim Lounge", "Steakhouse 71 Lounge"], "Disney\u2019s Animal Kingdom Lodge \u2013 Jambo": ["Cape Town Lounge & Wine Bar", "Uzima Springs Pool Bar", "Victoria Falls Lounge"], "Disney\u2019s Grand Floridian Resort": ["Courtyard Pool Bar", "Enchanted Rose Lounge"], "Disney\u2019s Fort Wilderness Resort & Campground": ["Crockett\u2019s Tavern"], "Disney\u2019s All\u2011Star Sports Resort": ["Grandstand Spirits"], "Disney\u2019s Old Key West Resort": ["Gurgling Suitcase"], "Disney\u2019s Animal Kingdom Lodge \u2013 Kidani": ["Maji Pool Bar", "Sanaa Lounge"], "Disney\u2019s Beach Club Resort": ["Martha\u2019s Vineyard Lounge"], "Disney\u2019s Port Orleans Resort \u2013 Riverside": ["Muddy Rivers Pool Bar", "River Roost Lounge"], "Disney\u2019s Pop Century Resort": ["Petals Pool Bar"], "Disney\u2019s Port Orleans Resort \u2013 French Quarter": ["Scat Cat\u2019s Club \u2013 Lounge"], "Disney\u2019s All\u2011Star Movies Resort": ["Silver Screen Spirits Bar"], "Disney\u2019s All\u2011Star Music Resort": ["Singing Spirits Bar"], "Disney\u2019s Polynesian Village Resort": ["Tambu Lounge", "Trader Sam\u2019s Grog Grotto", "Trader Sam\u2019s Tiki Terrace"], "Disney\u2019s Wilderness Lodge": ["Territory Lounge"], "Disney\u2019s Art of Animation Resort": ["The Drop Off Pool Bar"], "Disney\u2019s Riviera Resort": ["Voyageurs\u2019 Lounge"]}, "Disney Springs": {"Disney Springs": ["Dockside Margaritas", "Enzo\u2019s Hideaway Tunnel Bar", "House of Blues Front Porch Bar", "Jock Lindsey\u2019s Hangar Bar", "Paddlefish Rooftop Bar", "Raglan Road Bar (inside & exterior patio bar)", "STK Orlando Rooftop Bar", "Splitsville Bar", "Stargazers Bar (at Planet Hollywood, when operating seasonally)", "The BOATHOUSE Bars (indoor & Dockside)", "The Edison Bar", "Wine Bar George \u2013 Wine Bar"]}}};

    const BIN_ID = '6954b02eae596e708fbb8118';
    const API_KEY = '$2a$10$B2lcgtW9TRoKhvXKDEHxWenp5jGdJL.a2op6oWw8yoVf5Pocmtu3.'; 
    const URL = 'https://api.jsonbin.io/v3/b/' + BIN_ID;

    let data = { contracts: [], trips: [], plans: {}, lastSync: "" };
    let planMode = 'view';
    let currentPlanDate = null;

    async function init() {
        try {
            const res = await fetch(URL + '/latest', { headers: { 'X-Master-Key': API_KEY } });
            const cloud = await res.json();
            data = cloud.record || cloud;
            render();
            updatePlanDropdown();
        } catch (e) {
            const backup = localStorage.getItem('dvc_data_final');
            if(backup) { data = JSON.parse(backup); render(); }
        }
    }

    // --- PLANS LOGIC ---
    function updatePlanDropdown() {
        const sel = document.getElementById('planTripSelect');
        sel.innerHTML = '<option value="" disabled selected>Select Trip to Plan</option>';
        data.trips.forEach(t => sel.innerHTML += `<option value="${t.id}">${t.name}</option>`);
    }

    function initPlanView() {
        const tId = document.getElementById('planTripSelect').value;
        const trip = data.trips.find(t => t.id == tId);
        currentPlanDate = trip.start;
        loadPlans();
    }

    function setPlanMode(m) {
        planMode = m;
        document.getElementById('viewBtn').classList.toggle('active', m === 'view');
        document.getElementById('editBtn').classList.toggle('active', m === 'edit');
        document.getElementById('editNavArea').style.display = (m === 'edit' ? 'block' : 'none');
        loadPlans();
    }

    function changeDate(dir) {
        const trip = data.trips.find(t => t.id == document.getElementById('planTripSelect').value);
        let d = new Date(currentPlanDate + "T00:00:00");
        d.setDate(d.getDate() + dir);
        let newStr = d.toISOString().split('T')[0];
        if (newStr >= trip.start && newStr <= trip.end) { currentPlanDate = newStr; loadPlans(); }
    }

    function triggerDatePicker() { document.getElementById('jumpDatePicker').showPicker(); }
    function jumpToDate(val) {
        const tId = document.getElementById('planTripSelect').value;
        const trip = data.trips.find(t => t.id == tId);
        if (val >= trip.start && val <= trip.end) { currentPlanDate = val; loadPlans(); }
    }

    function loadPlans() {
        const tId = document.getElementById('planTripSelect').value;
        const container = document.getElementById('planDayContainer');
        const trip = data.trips.find(t => t.id == tId);
        document.getElementById('planArea').style.display = 'block';
        container.innerHTML = '';

        if (planMode === 'edit') {
            // SINGLE DAY EDIT LOGIC
            const dateObj = new Date(currentPlanDate + "T00:00:00");
            document.getElementById('displayDateText').innerText = dateObj.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'});
            
            const acts = data.plans[tId]?.[currentPlanDate + "_acts"] || [];
            acts.forEach((a, i) => container.appendChild(createActivityEditor(tId, i, a)));
            
            let addBtn = document.createElement('button');
            addBtn.className = "disney-button";
            addBtn.innerText = "+ Add Event for " + dateObj.toLocaleDateString('en-US', {day:'numeric'});
            addBtn.onclick = () => {
                if (!data.plans[tId]) data.plans[tId] = {};
                if (!data.plans[tId][currentPlanDate + "_acts"]) data.plans[tId][currentPlanDate + "_acts"] = [];
                data.plans[tId][currentPlanDate + "_acts"].push({ type: 'Other', start: '12:00' });
                loadPlans();
            };
            container.appendChild(addBtn);
        } else {
            // FULL TRIP VIEW LOGIC
            let start = new Date(trip.start + "T00:00:00");
            let end = new Date(trip.end + "T00:00:00");
            
            while(start <= end) {
                const ds = start.toISOString().split('T')[0];
                const dayActs = data.plans[tId]?.[ds + "_acts"] || [];
                
                let dayCard = document.createElement('div');
                dayCard.className = 'plan-day-card';
                let html = `<h4>${start.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'})}</h4>`;
                
                if(dayActs.length === 0) {
                    html += '<p style="font-size:0.8rem; color:#999; margin:5px 0;">No plans yet.</p>';
                } else {
                    dayActs.sort((a,b) => a.start.localeCompare(b.start)).forEach(a => {
                        html += `<div class="view-item">
                                    <div class="view-time">${formatTime(a.start)}${a.end ? ' - ' + formatTime(a.end) : ''}</div>
                                    <div class="view-desc"><strong>${a.selection || a.desc || 'Untitled'}</strong><br><small style="color:#666">${a.type}</small></div>
                                 </div>`;
                    });
                }
                dayCard.innerHTML = html;
                container.appendChild(dayCard);
                start.setDate(start.getDate() + 1);
            }
        }
    }

    function formatTime(t) {
        const [h, m] = t.split(':');
        return ((h % 12) || 12) + ":" + m + (h >= 12 ? ' PM' : ' AM');
    }

    function createActivityEditor(tId, idx, act) {
        const row = document.createElement('div');
        row.className = 'activity-row';
        row.innerHTML = `
            <span class="del-act-btn" onclick="deleteAct('${tId}', ${idx})">×</span>
            <div class="time-row">
                <div><label>Start</label><input type="time" value="${act.start}" onchange="updateAct('${tId}',${idx},'start',this.value)"></div>
                <div><label>End</label><input type="time" value="${act.end || ''}" onchange="updateAct('${tId}',${idx},'end',this.value)"></div>
            </div>
            <div class="smart-dropdowns">
                <label>Event Type</label>
                <select onchange="updateActType('${tId}',${idx},this.value)">
                    <option value="Other" ${act.type === 'Other' ? 'selected' : ''}>Other / Memo</option>
                    <option value="Dining" ${act.type === 'Dining' ? 'selected' : ''}>Dining</option>
                    <option value="Lightning Lane" ${act.type === 'Lightning Lane' ? 'selected' : ''}>Lightning Lane</option>
                    <option value="Show" ${act.type === 'Show' ? 'selected' : ''}>Show/Event</option>
                </select>
                <div id="subFields-${idx}"></div>
            </div>
        `;
        if (act.type === 'Dining') { setTimeout(() => renderDiningFields(tId, idx, act), 0); } 
        else { setTimeout(() => { document.getElementById(`subFields-${idx}`).innerHTML = `<label>Details</label><input type="text" placeholder="Description" value="${act.desc || ''}" onchange="updateAct('${tId}',${idx},'desc',this.value)">`; }, 0); }
        return row;
    }

    function renderDiningFields(tId, idx, act) {
        const target = document.getElementById(`subFields-${idx}`);
        target.innerHTML = `
            <label>Dining Type</label>
            <select id="srv-${idx}" onchange="updateDiningLogic('${tId}',${idx})">
                <option value="">-- Choose --</option>
                <option value="Quick Service" ${act.service === 'Quick Service' ? 'selected' : ''}>Quick Service</option>
                <option value="Table Service" ${act.service === 'Table Service' ? 'selected' : ''}>Table Service</option>
                <option value="Snack" ${act.service === 'Snack' ? 'selected' : ''}>Snack</option>
                <option value="Bar" ${act.service === 'Bar' ? 'selected' : ''}>Bar / Lounge</option>
            </select>
            <div id="locTypeArea-${idx}"></div>
            <div id="finalLocArea-${idx}"></div>
            <div id="restArea-${idx}"></div>
        `;
        if (act.service) updateDiningLogic(tId, idx, true);
    }

    function updateDiningLogic(tId, idx, isInitial = false) {
        const service = document.getElementById(`srv-${idx}`).value;
        const act = data.plans[tId][currentPlanDate + "_acts"][idx];
        if (!isInitial) { act.service = service; act.cat = ""; act.loc = ""; act.selection = ""; }
        const area = document.getElementById(`locTypeArea-${idx}`);
        if(!service) { area.innerHTML = ""; return; }
        area.innerHTML = `<label>Category</label><select id="cat-${idx}" onchange="updateDiningCat('${tId}',${idx})"><option value="">-- Select --</option>${Object.keys(diningDatabase[service]).map(c => `<option value="${c}" ${act.cat === c ? 'selected' : ''}>${c}</option>`).join('')}</select>`;
        if (act.cat) updateDiningCat(tId, idx, true);
    }

    function updateDiningCat(tId, idx, isInitial = false) {
        const service = document.getElementById(`srv-${idx}`).value;
        const cat = document.getElementById(`cat-${idx}`).value;
        const act = data.plans[tId][currentPlanDate + "_acts"][idx];
        if (!isInitial) { act.cat = cat; act.loc = ""; act.selection = ""; }
        const area = document.getElementById(`finalLocArea-${idx}`);
        if(!cat) { area.innerHTML = ""; return; }
        const options = Object.keys(diningDatabase[service][cat]);
        area.innerHTML = `<label>Location</label><select id="loc-${idx}" onchange="updateDiningRest('${tId}',${idx})"><option value="">-- Choose --</option>${options.map(o => `<option value="${o}" ${act.loc === o ? 'selected' : ''}>${o}</option>`).join('')}</select>`;
        if (act.loc) updateDiningRest(tId, idx, true);
    }

    function updateDiningRest(tId, idx, isInitial = false) {
        const service = document.getElementById(`srv-${idx}`).value;
        const cat = document.getElementById(`cat-${idx}`).value;
        const loc = document.getElementById(`loc-${idx}`).value;
        const act = data.plans[tId][currentPlanDate + "_acts"][idx];
        if (!isInitial) { act.loc = loc; act.selection = ""; }
        const area = document.getElementById(`restArea-${idx}`);
        if(!loc) { area.innerHTML = ""; return; }
        const rests = diningDatabase[service][cat][loc];
        area.innerHTML = `<label>Specific Venue</label><select onchange="updateAct('${tId}',${idx},'selection',this.value)"><option value="">-- Choose Venue --</option>${rests.map(r => `<option value="${r}" ${act.selection === r ? 'selected' : ''}>${r}</option>`).join('')}</select>`;
    }

    function updateActType(tId, idx, val) { data.plans[tId][currentPlanDate + "_acts"][idx] = { start: data.plans[tId][currentPlanDate + "_acts"][idx].start, type: val }; loadPlans(); }
    function updateAct(tId, idx, key, val) { data.plans[tId][currentPlanDate + "_acts"][idx][key] = val; }
    function deleteAct(tId, idx) { if(confirm("Remove?")) { data.plans[tId][currentPlanDate + "_acts"].splice(idx, 1); loadPlans(); } }

    // --- DASHBOARD & CONTRACTS ---
    function render() {
        const summary = document.getElementById('contractSummary');
        const editor = document.getElementById('contractEditor');
        const nextTripDiv = document.getElementById('nextTripDisplay');
        const tripList = document.getElementById('tripManager');
        const syncStamp = document.getElementById('lastSync');
        let totalPts = 0;

        summary.innerHTML = ''; editor.innerHTML = ''; nextTripDiv.innerHTML = ''; tripList.innerHTML = '';
        syncStamp.innerText = data.lastSync ? "Cloud Updated: " + data.lastSync : "Check Sync Status";

        data.contracts.forEach(c => {
            let used = (c.used || 0);
            let remBanked = Math.max(0, (c.banked || 0) - used);
            used = Math.max(0, used - (c.banked || 0));
            let remCur = Math.max(0, c.annual - used);
            let remFut = Math.max(0, c.annual - (c.borrowed || 0));
            totalPts += (remBanked + remCur + remFut);

            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const today = new Date();
            const uyIdx = months.indexOf(c.uy.substring(0,3));
            let curUYYear = (today.getMonth() < uyIdx) ? today.getFullYear() - 1 : today.getFullYear();
            const expire = new Date(curUYYear + 1, uyIdx, 0).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});

            summary.innerHTML += `<div class="dashboard-contract-card"><div class="card-header"><span>${c.resort}</span><small>${c.uy.toUpperCase()} UY</small></div><div class="point-grid"><div class="point-box"><span class="point-val">${remBanked}</span><span class="point-label">Banked</span></div><div class="point-box"><span class="point-val">${remCur}</span><span class="point-label">Current</span></div><div class="point-box"><span class="point-val">${remFut}</span><span class="point-label">Future</span></div></div><div class="expiration-alert">⚠️ ${curUYYear - 1} BANKED POINTS EXPIRE ${expire.toUpperCase()}</div></div>`;
            editor.innerHTML += `<div class="dashboard-contract-card" style="padding:15px;"><div style="display:flex; justify-content:space-between"><strong>${c.resort}</strong><span style="color:red; cursor:pointer" onclick="deleteContract(${c.id})">Delete</span></div><div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; margin-top:10px"><span>Banked<br><input type="number" style="width:100%" value="${c.banked}" onchange="updateContract(${c.id}, 'banked', this.value)"></span><span>Annual<br><input type="number" style="width:100%" value="${c.annual}" disabled></span><span>Borrow<br><input type="number" style="width:100%" value="${c.borrowed}" onchange="updateContract(${c.id}, 'borrowed', this.value)"></span></div><div style="text-align:right; margin-top:10px;">Used: <input type="number" style="width:80px; text-align:center;" value="${c.used}" onchange="updateContract(${c.id}, 'used', this.value)"></div></div>`;
        });

        document.getElementById('grandTotal').innerText = `TOTAL: ${totalPts} PTS`;
        const sorted = data.trips.sort((a,b) => new Date(a.start + "T00:00:00") - new Date(b.start + "T00:00:00"));
        const todayLocal = new Date(); todayLocal.setHours(0,0,0,0);

        sorted.forEach((t, index) => {
            const s = new Date(t.start + "T00:00:00");
            const e = new Date(t.end + "T00:00:00");
            if (index === 0 && todayLocal <= e) {
                let status = (todayLocal < s) ? `${Math.ceil((s - todayLocal) / (1000*60*60*24))} DAYS UNTIL` : "WELCOME HOME!";
                nextTripDiv.innerHTML = `<div class="trip-card"><div><strong>${t.name}</strong><br><small>${t.resort}</small></div><div>${status}</div></div>`;
            }
            tripList.innerHTML += `<div class="trip-card"><div>${t.name} (${t.start})</div><button onclick="deleteTrip(${t.id})" style="background:none;border:none;color:red;font-weight:bold; cursor:pointer;">X</button></div>`;
        });
    }

    async function saveToCloud() {
        const btns = document.querySelectorAll('.sync-btn');
        btns.forEach(b => b.innerText = "SYNCING...");
        data.lastSync = new Date().toLocaleString();
        try {
            await fetch(URL, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY }, body: JSON.stringify(data) });
            localStorage.setItem('dvc_data_final', JSON.stringify(data));
            btns.forEach(b => b.innerText = "SUCCESS! ✅");
        } catch (e) { b.innerText = "FAIL"; }
        setTimeout(() => { btns.forEach(b => b.innerText = "PUSH TO CLOUD"); render(); }, 2000);
    }

    function addTrip() {
        const name = document.getElementById('tripName').value;
        const resort = document.getElementById('tripResort').value;
        const start = document.getElementById('checkIn').value;
        const end = document.getElementById('checkOut').value;
        if(!name || !resort || !start || !end) return;
        data.trips.push({ id: Date.now(), name, resort, start, end });
        render(); updatePlanDropdown(); document.getElementById('tripName').value = '';
    }

    function updateContract(id, key, val) { const idx = data.contracts.findIndex(c => c.id === id); data.contracts[idx][key] = parseInt(val) || 0; render(); }
    function deleteTrip(id) { if(confirm("Delete trip?")) { data.trips = data.trips.filter(t => t.id !== id); render(); updatePlanDropdown(); } }
    function deleteContract(id) { if(confirm("Delete?")) { data.contracts = data.contracts.filter(c => c.id !== id); render(); } }

    init();
</script>
</body>
</html>
